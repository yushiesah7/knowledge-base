# tmux の仕組みと概念

> tmux がどう動いているか、用語やアーキテクチャの理解を目的としたドキュメント。
> コマンドリファレンスは `commands.md`、実践レシピは `recipes.md` を参照。

---

## tmux とは

**terminal multiplexer** の略。1つのターミナルの中で複数の仮想端末を管理するツール。
SSH接続が切れても作業が残り、後から再接続できるのが最大の強み。

---

## アーキテクチャ: サーバー/クライアントモデル

tmux は **サーバープロセス** と **クライアントプロセス** に分かれている。

```
┌──────────────────────────────────────────────────┐
│                  tmux server                      │
│  (バックグラウンドで常駐するプロセス)                  │
│                                                    │
│  ┌─────────────┐  ┌─────────────┐                 │
│  │ Session: dev │  │ Session: ops│                 │
│  │             │  │             │                 │
│  │ ┌─────────┐ │  │ ┌─────────┐ │                 │
│  │ │Window: 0│ │  │ │Window: 0│ │                 │
│  │ │ editor  │ │  │ │ monitor │ │                 │
│  │ │┌──┬───┐│ │  │ │┌───────┐│ │                 │
│  │ ││P0│P1 ││ │  │ ││ P0    ││ │                 │
│  │ │└──┴───┘│ │  │ │└───────┘│ │                 │
│  │ └─────────┘ │  │ └─────────┘ │                 │
│  │ ┌─────────┐ │  └─────────────┘                 │
│  │ │Window: 1│ │                                   │
│  │ │ server  │ │                                   │
│  │ │┌───────┐│ │                                   │
│  │ ││ P0    ││ │                                   │
│  │ │└───────┘│ │                                   │
│  │ └─────────┘ │                                   │
│  └─────────────┘                                   │
└──────────────────────────────────────────────────┘
         ▲              ▲
         │ attach        │ attach
    ┌────┴────┐    ┌────┴────┐
    │ Client A│    │ Client B│
    │(端末1)   │    │(端末2)   │
    └─────────┘    └─────────┘
```

### サーバー
- `tmux` コマンドを初めて実行すると自動的に起動する
- 全てのセッション・ウィンドウ・ペインを管理する
- クライアントが全て切断されても **サーバーは動き続ける**
- `tmux kill-server` で明示的に止めない限り終了しない

### クライアント
- ターミナルから `tmux attach` するたびに1つのクライアントが生まれる
- クライアントはサーバーに接続して画面を表示するだけの存在
- デタッチ（`Ctrl+b d`）するとクライアントが切断されるが、セッションは生きている

### なぜこれが重要か
- SSH先でtmuxを使えば、接続が切れてもプロセスが死なない
- 別の端末から同じセッションに再接続できる
- 複数人で同じセッションを共有することも可能

---

## 3つの階層: セッション > ウィンドウ > ペイン

tmux の管理単位は3階層:

```
Session（セッション）
├── Window 0（ウィンドウ）= タブのようなもの
│   ├── Pane 0（ペイン）= 画面分割の1区画
│   └── Pane 1
├── Window 1
│   └── Pane 0
└── Window 2
    ├── Pane 0
    ├── Pane 1
    └── Pane 2
```

| 階層 | 概念 | たとえ |
|---|---|---|
| **Session** | 作業単位の最上位。プロジェクトや目的ごとに分ける | ブラウザのウィンドウ |
| **Window** | セッション内のタブ。画面全体を使う | ブラウザのタブ |
| **Pane** | ウィンドウ内の分割された区画 | 画面分割 |

### 使い分けの指針

- **セッション**: プロジェクト単位、または作業目的（開発/運用/学習）で分ける
- **ウィンドウ**: 役割（エディタ/サーバー/Git/ターミナル）で分ける
- **ペイン**: 同時に見たいもの（ログとコマンドなど）で分ける

---

## プレフィックスキー

tmux のキーバインドは全て **プレフィックスキー** の後に続けて打つ。

- デフォルト: `Ctrl+b`
- 例: ウィンドウ作成 = `Ctrl+b` を押す → 手を離す → `c` を押す

### プレフィックスキーを変更するには

`~/.tmux.conf` に記載:

```
# Ctrl+a に変更する例（screenと同じ）
unbind C-b
set -g prefix C-a
bind C-a send-prefix
```

---

## 設定ファイル: ~/.tmux.conf

tmux 起動時に読み込まれる設定ファイル。存在しなくても動作する。

```bash
# 設定ファイルの場所
~/.tmux.conf

# 変更後に再読み込み
tmux source-file ~/.tmux.conf
```

### 設定の種類

| 種類 | コマンド | 説明 |
|---|---|---|
| サーバーオプション | `set -s` | サーバー全体に適用 |
| グローバルセッション | `set -g` | 全セッションのデフォルト |
| グローバルウィンドウ | `set -gw` | 全ウィンドウのデフォルト |

### よく使う設定例

```bash
# ~/.tmux.conf

# マウスを有効にする
set -g mouse on

# 256色対応
set -g default-terminal "screen-256color"

# ステータスバーを上に表示
set -g status-position top

# ウィンドウ番号を1始まりにする
set -g base-index 1
setw -g pane-base-index 1

# ウィンドウを閉じたとき番号を詰める
set -g renumber-windows on

# スクロールバッファを増やす
set -g history-limit 50000

# エスケープキーの遅延をなくす（vim使い向け）
set -s escape-time 0
```

---

## 環境変数とシェルの関係

- 各ペインは独立した **シェルプロセス** を持つ
- ペインを開くとデフォルトシェル（`$SHELL`）が起動する
- `-c` オプションで指定したディレクトリがそのシェルの初期ディレクトリになる
- 環境変数はペイン間で共有されない（それぞれ独立したプロセス）

```
tmux server
└── Session
    └── Window
        ├── Pane 0 → /bin/zsh (PID: 1234, CWD: ~/Projects/fe)
        └── Pane 1 → /bin/zsh (PID: 1235, CWD: ~/Projects/be)
```

---

## ソケットによる通信

tmux のサーバーとクライアントは **Unixドメインソケット** で通信する。

```bash
# デフォルトのソケットパス
/tmp/tmux-$(id -u)/default

# ソケットを指定して起動（複数サーバーを使い分け可能）
tmux -L mysocket new-session -s test
tmux -L mysocket attach -t test
```

これにより:
- 同一マシン上で複数の独立した tmux サーバーを走らせられる
- 権限の異なるユーザー間でセッションを分離できる

---

## ライフサイクルまとめ

```
1. tmux new-session    → サーバー起動（初回のみ）+ セッション作成 + クライアント接続
2. Ctrl+b d            → クライアント切断（セッションは生存）
3. tmux attach         → 別のクライアントで再接続
4. exit（最後のペイン） → セッション終了
5. 全セッション終了     → サーバー自動終了
```

| 状態 | サーバー | セッション | クライアント |
|---|---|---|---|
| `new-session` | 起動 | 作成 | 接続 |
| `Ctrl+b d` | 動作中 | 生存 | 切断 |
| `attach` | 動作中 | 生存 | 再接続 |
| `kill-session` | 動作中 | 削除 | 切断 |
| `kill-server` | 停止 | 全削除 | 全切断 |
